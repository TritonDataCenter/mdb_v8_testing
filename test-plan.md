# mdb_v8 changes

This change makes a bunch of improvements to mdb\_v8:

* The findjsobjects command now prunes a lot more garbage objects.  It does this
  largely by looking at the properties of an object and treating the object as
  garbage if any of the property values themselves look like garbage.
* The jsprint command now groks RegExp objects.
* Bug fix: Some Date objects were not printed correctly.
* Bug fix: with v0.12 core files, some objects' properties are not printed
  correctly.
* Bug fix: With some 64-bit v0.10 core files, some objects were erroneously
  considered garbage because they had extra "undefined" properties.
* Bug fix: the test-postmortem-jsstack test case was failing spuriously due to
  tail call elimination in V8.
* Bug fix: the module could crash when asked to print some very bad strings.
* Bug fix: the module could crash under some conditions when asked to print
  very large external strings.
* Fixes a bunch of cstyle nits


# Test plan

## Checklist

* done: self-review
* done: cstyle.pl
* done: automated tests (32-bit)
* done: automated tests (64-bit)
* done: automated tests (v0.10, 32-bit)
* done: automated tests (v0.12, 64-bit)
* done: rerun manual test cases below and recheck them


## Test cases and reports

I used three main programs to test, found in the "test-programs" directory.

* "explicit-abort": a script that just calls `process.abort()` immediately at
  the top level
* "defer-abort": a script that calls `process.abort()` in a setImmediate
  callback.
* "gcore-loop": a script that calls several functions, the last of which goes
  into an infinite loop with a known object on the stack

For each Node configuration (32-bit and 64-bit, v0.10 and v0.12), I run each of
the test programs.  The "-abort" test cases crash and generate a core file.  I
use "gcore" to save a core dump from the "gcore" test case.  For each core file,
there are five reports that get run, found in the "core-reports" directory:

* objects-badprops.txt: uses the debugger module to print objects filtered out
  by the new code.  This output is skimmed by hand to look for things that
  should not have been filtered.
* objects-nongarbage.txt: uses the debugger module to print all valid,
  non-garbage objects in the core file.  This output is skimmed by hand to look
  for things that should have been filtered, though we don't yet catch
  everything.
* process.txt: uses the debugger module to try to print version information from
  the "process" object.
* specialobj.txt: uses the debugger module to find and print the sentinel object
  we've injected into the simple programs above.
* undefpropnames.txt: uses the debugger module to find and print objects with
  "undefined" property names, a special case added under this change.

Besides the core files generated by this test plan, I also took core files from
real pre-production systems and ran the same reports on them.


## Results

Sanity checks:

* All expected 32-bit core files are 32-bit
* All expected 64-bit core files are 64-bit
* All v0.10.30 core files are V8 version 3.14.5.9
* All v0.12.2 core files are V8 version 3.28.73.0

**objects-badprops.txt:**

Core files: (32-bit, 64-bit) x (v0.10.30, v0.12.2) x (three test cases above)

The above command shows the objects that have been filtered by this change.  For
each of the test cases, I checked the output of the "badprops" report for any
objects that appeared valid, and didn't find any.

**objects-nongarbage.txt:**

Core files: (32-bit, 64-bit) x (v0.10.30, v0.12.2) x (three test cases above)

The report prints the contents of all objects visible to findjsobjects, using a
jsprint depth of 1 and a maximum jsprint buffer size of 160 (which is used to
avoid printing giant strings representing file contents, which mess up
heuristics for guessing).  On the output files, there were no matches for the
text "warning" or "error".  I looked for warnings from the debugger (identified
by "&lt;" characters that aren't part of "<anonymous>" or "<anon>"), and found
only:

* problems with array elements (which aren't fixed by this change, but also
  aren't searchable with findjsobjects)
* problems related to specific errors that we're choosing to ignore (e.g.,
  warnings about accessors)

Given that this change attempts to remove garbage, it's not the end of the world
if we don't properly remove _all_ garbage, as long as we're making things
better.

**process.txt:**

Core files: (32-bit, 64-bit) x (v0.10.30, v0.12.2) x (three test cases above
plus two production core files)

In all core files, there was at least one "process" object with the right
"platform", "arch", "version" and "versions.v8" fields.

**specialobj.txt:**

At least one instance of the special sentinel object was found and printed
correctly in all instances of the "gcore" test case.

**undefpropnames.txt:**

The only core file with this kind of object turned out to be one of the v0.10.30
64-bit core files.


# Notes for future work

* It looks like we could prune more garbage by checking whether the pointers
  referenced by a ConsString are themselves garbage.
* For testing, it would be useful to have a dcmd for walking the object graph
  from a given object and seeing whether anything it points to looks like
  garbage.  This way, we could take an object we believe is good, and make sure
  that everything reachable from that object looks valid.  It would also help
  point to valid constructs that we don't yet grok.
* It would be handy to have dcmds for selecting arrays and arrays of length N.
* It would be handy to have dcmds for filtering on V8 types (like FixedArray).
  We could use this, e.g., to identify all forms of JSDate.
* Many objects identified as garbage appear to have DebugInfo objects that might
  otherwise be okay.
* It would be great if we could print out Accessors more usefully.
* There are also some objects marked as garbage (category "badprop") that look
  basically fine except that we don't know how to print a FunctionTemplateInfo.
* To automate the currently manual process of scanning through output looking
  for things that "look wrong", it would be helpful to be able to print out
  objects for which printing out property values of that object results in some
  detected error, maybe classified by error.  Right now I'm using a regexp to do
  this, and there are many categories of false positives.
* When we print many kinds of strings and find an error, we don't always close
  the quote.
* We don't quote strings properly anyway because we don't escape the quotes.
* To build some of these tools, it may be helpful for mdb\_v8 to have a dcmd
  that prints out a complete manifest of _everything_ it finds: V8 objects, JS
  objects, and so on.  It would only keep track of pointers that it has already
  printed.  Maybe this could be turned into a little database with a separate
  program for exploring it.  If nothing else, this would be a useful development
  tool.
